name: release-binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

permissions:
  contents: write
  actions: read

env:
  VITE_API_URL: /api

jobs:
  linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            cc: gcc
          - goos: linux
            goarch: arm64
            cc: aarch64-linux-gnu-gcc
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: server/go.sum

      - name: Install cross toolchains
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build frontend
        working-directory: web
        run: |
          set -euo pipefail
          npm ci
          npm run build

      - name: Prepare embedded assets
        run: |
          set -euo pipefail
          rm -rf server/frontend/ui
          mkdir -p server/frontend/ui
          cp -R web/dist/. server/frontend/ui/

      - name: Build Go binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
          CC: ${{ matrix.cc }}
          OUTPUT_DIR: ${{ github.workspace }}/dist
          OUTPUT_NAME: content-hub-${{ matrix.goos }}-${{ matrix.goarch }}
        run: |
          set -euo pipefail
          ./build_release.sh

      - name: Verify artifact
        run: |
          set -euo pipefail
          ls -lah ${{ github.workspace }}/dist
          test -f ${{ github.workspace }}/dist/content-hub-${{ matrix.goos }}-${{ matrix.goarch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: content-hub-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ github.workspace }}/dist/content-hub-${{ matrix.goos }}-${{ matrix.goarch }}

  macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: server/go.sum

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build frontend
        working-directory: web
        run: |
          set -euo pipefail
          npm ci
          npm run build

      - name: Prepare embedded assets
        run: |
          set -euo pipefail
          rm -rf server/frontend/ui
          mkdir -p server/frontend/ui
          cp -R web/dist/. server/frontend/ui/

      - name: Build Go binary (darwin arm64)
        env:
          GOOS: darwin
          GOARCH: arm64
          CGO_ENABLED: 1
          OUTPUT_DIR: ${{ github.workspace }}/dist
          OUTPUT_NAME: content-hub-darwin-arm64
        run: |
          set -euo pipefail
          ./build_release.sh

      - name: Verify artifact
        run: |
          set -euo pipefail
          ls -lah ${{ github.workspace }}/dist
          test -f ${{ github.workspace }}/dist/content-hub-darwin-arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: content-hub-darwin-arm64
          path: ${{ github.workspace }}/dist/content-hub-darwin-arm64

  windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: server/go.sum

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build frontend
        working-directory: web
        run: |
          set -euo pipefail
          npm ci
          npm run build

      - name: Prepare embedded assets
        run: |
          set -euo pipefail
          rm -rf server/frontend/ui
          mkdir -p server/frontend/ui
          cp -R web/dist/. server/frontend/ui/

      - name: Build Go binary (windows amd64)
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 1
          CC: x86_64-w64-mingw32-gcc
          OUTPUT_DIR: ${{ github.workspace }}/dist
          OUTPUT_NAME: content-hub-windows-amd64.exe
        run: |
          set -euo pipefail
          choco install -y mingw
          ./build_release.sh

      - name: Verify artifact
        run: |
          set -euo pipefail
          ls -lah ${{ github.workspace }}/dist
          test -f ${{ github.workspace }}/dist/content-hub-windows-amd64.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: content-hub-windows-amd64
          path: ${{ github.workspace }}/dist/content-hub-windows-amd64.exe

  release:
    needs: [linux, macos, windows]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-artifacts/content-hub-linux-amd64/content-hub-linux-amd64
            dist-artifacts/content-hub-linux-arm64/content-hub-linux-arm64
            dist-artifacts/content-hub-darwin-arm64/content-hub-darwin-arm64
            dist-artifacts/content-hub-windows-amd64/content-hub-windows-amd64.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
